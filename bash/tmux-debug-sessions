#!/bin/bash
# ~/.local/bin/tmux-debug-sessions
# Debug what's happening with session restoration

RESURRECT_DIR="$HOME/.config/local/share/tmux/resurrect"
NAMED_DIR="$HOME/.config/local/share/tmux/named-sessions"

echo "ðŸ” Session Debug Information"
echo "============================"
echo ""

echo "ðŸ“ Resurrect Directory: $RESURRECT_DIR"
if [ -d "$RESURRECT_DIR" ]; then
    echo "   âœ… Directory exists"
    echo "   ðŸ“Š Files found: $(find "$RESURRECT_DIR" -name "*.txt" | wc -l)"

    if [ "$(find "$RESURRECT_DIR" -name "*.txt" | wc -l)" -gt 0 ]; then
        echo ""
        echo "ðŸ“‹ Auto-save files (newest first):"
        ls -lat "$RESURRECT_DIR"/*.txt 2>/dev/null | head -5 | while read -r line; do
            echo "   $line"
        done

        echo ""
        latest=$(ls -t "$RESURRECT_DIR"/*.txt 2>/dev/null | head -1)
        echo "ðŸŽ¯ Latest auto-save file: $(basename "$latest")"
        echo "   ðŸ“ Size: $(ls -lah "$latest" | awk '{print $5}')"
        echo "   ðŸ“… Date: $(stat -c %y "$latest" | cut -d' ' -f1,2)"
    else
        echo "   âŒ No .txt files found in resurrect directory"
    fi
else
    echo "   âŒ Directory does not exist"
fi

echo ""
echo "ðŸ·ï¸  Named Sessions Directory: $NAMED_DIR"
if [ -d "$NAMED_DIR" ]; then
    echo "   âœ… Directory exists"
    echo "   ðŸ“Š Files found: $(find "$NAMED_DIR" -name "*.txt" | wc -l)"

    if [ "$(find "$NAMED_DIR" -name "*.txt" | wc -l)" -gt 0 ]; then
        echo ""
        echo "ðŸ“‹ Named session files:"
        ls -lat "$NAMED_DIR"/*.txt 2>/dev/null | while read -r line; do
            echo "   $line"
        done
    else
        echo "   ðŸ“­ No named session files"
    fi
else
    echo "   âŒ Directory does not exist"
fi

echo ""
echo "ðŸ”§ Resurrect Script Check:"
restore_script="$HOME/.config/tmux/plugins/tmux-resurrect/scripts/restore.sh"
if [ -f "$restore_script" ]; then
    echo "   âœ… Restore script found: $restore_script"
    echo "   ðŸ”‘ Permissions: $(ls -la "$restore_script" | awk '{print $1}')"
else
    echo "   âŒ Restore script NOT found at: $restore_script"
    echo "   ðŸ’¡ Checking alternative location..."
    alt_script="$HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh"
    if [ -f "$alt_script" ]; then
        echo "   âœ… Found at alternative location: $alt_script"
    else
        echo "   âŒ Not found at alternative location either"
    fi
fi

echo ""
echo "ðŸ§ª Quick Tests:"
echo ""

# Test 1: Can we save a session?
echo "Test 1: Saving a test session..."
save_script="$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh"
if [ -f "$save_script" ]; then
    "$save_script"
    if [ $? -eq 0 ]; then
        echo "   âœ… Save test successful"
    else
        echo "   âŒ Save test failed"
    fi
else
    echo "   âŒ Save script not found"
fi

echo ""
echo "Press any key to close..."
read -t 30 -n 1 2>/dev/null || true
