#!/bin/bash
# ~/.local/bin/tmux-safe-save
# Purpose: Safely save tmux session and ensure "last" points to valid file

RESURRECT_DIR="$HOME/.config/local/share/tmux/resurrect"
SAVE_SCRIPT="$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh"

echo "ğŸ’¾ TMux Safe Session Saver"
echo "=========================="

# Check if save script exists
if [ ! -f "$SAVE_SCRIPT" ]; then
  echo "âŒ tmux-resurrect save script not found at: $SAVE_SCRIPT"
  echo "ğŸ’¡ Make sure tmux-resurrect plugin is installed"
  exit 1
fi

# Check if resurrect directory exists
if [ ! -d "$RESURRECT_DIR" ]; then
  echo "ğŸ“ Creating resurrect directory: $RESURRECT_DIR"
  mkdir -p "$RESURRECT_DIR"
fi

echo "ğŸ“ Resurrect directory: $RESURRECT_DIR"
echo "ğŸ”§ Save script: $SAVE_SCRIPT"
echo ""

# Get the current latest file before saving (for comparison)
BEFORE_FILES=($(ls -t "$RESURRECT_DIR"/tmux_resurrect_*.txt 2>/dev/null))
BEFORE_COUNT=${#BEFORE_FILES[@]}

echo "ğŸ“Š Current session files: $BEFORE_COUNT"
if [ $BEFORE_COUNT -gt 0 ]; then
  echo "ğŸ“„ Most recent: $(basename "${BEFORE_FILES[0]}")"
fi
echo ""

echo "ğŸ”„ Running tmux-resurrect save..."

# Run the save script and capture its output
if "$SAVE_SCRIPT"; then
  echo "âœ… Save script completed"
else
  echo "âŒ Save script failed with exit code $?"
  exit 1
fi

echo ""
echo "ğŸ” Checking save results..."

# Get the current latest file after saving
AFTER_FILES=($(ls -t "$RESURRECT_DIR"/tmux_resurrect_*.txt 2>/dev/null))
AFTER_COUNT=${#AFTER_FILES[@]}

if [ $AFTER_COUNT -le $BEFORE_COUNT ]; then
  echo "âš ï¸  Warning: No new session file was created"
  echo "ğŸ’¡ tmux-resurrect save may have failed"
  exit 1
fi

# Check the newest file
NEWEST_FILE="${AFTER_FILES[0]}"
NEWEST_SIZE=$(stat -c%s "$NEWEST_FILE" 2>/dev/null || echo 0)

echo "ğŸ“„ New session file: $(basename "$NEWEST_FILE")"
echo "ğŸ“ File size: $NEWEST_SIZE bytes"

# Validate the save looks good
if [ "$NEWEST_SIZE" -lt 100 ]; then
  echo "âŒ Warning: Save file seems too small ($NEWEST_SIZE bytes)"
  echo "ğŸ’¡ This might indicate a problem with the session save"

  # Don't update "last" if the save looks bad
  echo "ğŸ›¡ï¸  Not updating 'last' symlink due to suspicious file size"
  echo "ğŸ“ File saved as: $NEWEST_FILE"
  echo "ğŸ”§ You can manually fix this later with: tmux-fix-last"
  exit 1
else
  echo "âœ… Save file looks good ($NEWEST_SIZE bytes)"
fi

echo ""
echo "ğŸ”— Updating 'last' symlink..."

# Change to resurrect directory
cd "$RESURRECT_DIR" || {
  echo "âŒ Cannot access resurrect directory"
  exit 1
}

# Update the "last" symlink to point to our new file
BASENAME_NEWEST=$(basename "$NEWEST_FILE")

# Remove old symlink if it exists
if [ -L "last" ] || [ -f "last" ]; then
  rm -f "last"
fi

# Create new symlink
if ln -sf "$BASENAME_NEWEST" "last"; then
  echo "âœ… Updated 'last' symlink -> $BASENAME_NEWEST"

  # Verify the symlink points to the right file and get the target file size
  if [ -f "last" ]; then
    # Follow the symlink to get the actual file size
    VERIFY_SIZE=$(stat -L -c%s "last" 2>/dev/null || echo 0)
    VERIFY_TARGET=$(readlink "last" 2>/dev/null || echo "unknown")
    echo "ğŸ” Verification: 'last' -> $VERIFY_TARGET ($VERIFY_SIZE bytes)"

    # Double-check that we're pointing to the right file
    if [ "$VERIFY_TARGET" = "$BASENAME_NEWEST" ] && [ "$VERIFY_SIZE" -eq "$NEWEST_SIZE" ]; then
      echo "âœ… Symlink verification successful"
    else
      echo "âš ï¸  Symlink verification warning - sizes don't match"
      echo "    Expected: $BASENAME_NEWEST ($NEWEST_SIZE bytes)"
      echo "    Got: $VERIFY_TARGET ($VERIFY_SIZE bytes)"
    fi
  fi
else
  echo "âŒ Failed to update 'last' symlink"
  exit 1
fi

echo ""
echo "ğŸ‰ Safe save completed successfully!"
echo "ğŸ“ Session saved: $(basename "$NEWEST_FILE")"
echo "ğŸ”— 'last' symlink updated"
echo "ğŸ’¾ Size: $NEWEST_SIZE bytes"
echo ""
echo "âœ… tmux-resurrect should now restore this session reliably"
